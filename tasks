ğŸ“Š Solution Overview
Magic Link Token
64-character hex string (256-bit security)

Never expires (no expiration date)

Reusable forever (generates new session cookie each time)

Unique per user (1:1 mapping with email)

Format: https://sparkeefy.com/auth/magic?token={magicLinkToken}

Email Delivery
Native Node.js SMTP using net and tls modules

No external dependencies (no nodemailer)

Free Gmail SMTP (500 emails/day)

HTML email template with professional styling

ğŸ—„ï¸ Database Schema Update
Add to schema.prisma:
text
model WaitlistUser {
  // ... existing fields ...

  // Magic Link Authentication (NEW)
  magicLinkToken    String   @unique @map("magic_link_token") @db.VarChar(64)

  // Indexes (UPDATE)
  @@index([magicLinkToken]) // NEW INDEX
}
Migration SQL:
Download: migration_magic_link.sql

sql
-- Add magic link token column
ALTER TABLE waitlist_users ADD COLUMN magic_link_token VARCHAR(64) UNIQUE;
CREATE INDEX idx_magic_link_token ON waitlist_users(magic_link_token);

ğŸ“ Files to Create/Update
âœ… NEW FILES:
src/backend/services/EmailService.ts - Native SMTP implementation

migration_magic_link.sql - Database migration

âœ… UPDATE FILES:
src/backend/utils/generators.ts - Add generateMagicLinkToken()

src/backend/utils/links.ts - Add buildMagicLinkUrl()

src/backend/services/WaitlistService.ts - Add findUserByMagicLinkToken()

src/backend/trpc/procedures/waitlist.ts - Add authenticateWithMagicLink procedure

src/backend/config.ts - Add SMTP configuration

src/backend/types/index.ts - Update response types

src/backend/db/schema.prisma - Add magicLinkToken field

.env - Add SMTP credentials

ğŸ”§ Implementation Details
1. Email Service (Native SMTP)
Key Features:

Uses Node.js tls module for secure connectionsâ€‹

Implements SMTP AUTH LOGIN protocol

Supports HTML email with MIME multipart/alternativeâ€‹

No external dependencies (100% native)

Configuration (.env):

text
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-specific-password
SMTP_FROM=noreply@sparkeefy.com
Gmail Setup:

Enable 2FA on Google account

Generate app password: https://myaccount.google.com/apppasswords

Copy 16-character password

Use in .env as SMTP_PASS

2. Magic Link Workflow
text
User Journey:
1. User joins waitlist â†’ magicLinkToken generated + emailed
2. User clicks email link â†’ validates token â†’ sets cookie â†’ redirects
3. User can reuse link anytime â†’ new cookie generated each time
4. Cookie expires after 30 days â†’ user clicks magic link again â†’ new cookie
5. User changes device â†’ clicks magic link â†’ works seamlessly

Backend Flow:
POST /trpc/waitlist.join
  â†’ Generate magicLinkToken
  â†’ Save to database
  â†’ Send email via SMTP
  â†’ Return magicLinkUrl to frontend

GET /auth/magic?token=...
  â†’ Frontend calls: trpc.waitlist.authenticateWithMagicLink.mutate({ token })
  â†’ Validate token in database
  â†’ Generate new sessionToken
  â†’ Set httpOnly cookie
  â†’ Return user stats
3. Security Properties
âœ… 256-bit entropy (2^256 combinations - collision-proof)
âœ… Never expires (works forever unless manually revoked)
âœ… Cannot be guessed (cryptographically random)
âœ… Tied to email (revocable by regenerating token)
âœ… HTTPS required in production
âœ… Separate from session cookie (independent authentication)

âš ï¸ Code Debt Warnings
Acceptable for MVP:
No email queue - Emails sent synchronously (blocks request)

No retry logic - Failed emails not retried automatically

No delivery tracking - Cannot track opens/clicks

Basic SMTP - No connection pooling or rate limiting

Production Recommendations (Post-MVP):
Add email queue (Bull/BullMQ) for async sending

Implement retry logic for failed sends

Add delivery webhooks (SendGrid/Mailgun)

Track email analytics (opens, clicks, bounces)

ğŸ“¦ Dependencies
Zero new dependencies! Everything uses Node.js built-in modules:

net - TCP sockets

tls - TLS/SSL connections

crypto - Random token generation

ğŸš€ Deployment Checklist
text
[ ] 1. Update schema.prisma (add magicLinkToken field)
[ ] 2. Run: pnpm prisma db push
[ ] 3. Create EmailService.ts
[ ] 4. Update generators.ts (add generateMagicLinkToken)
[ ] 5. Update links.ts (add buildMagicLinkUrl)
[ ] 6. Update WaitlistService.ts (add findUserByMagicLinkToken)
[ ] 7. Update procedures/waitlist.ts (add authenticateWithMagicLink)
[ ] 8. Update config.ts (add SMTP config)
[ ] 9. Update types/index.ts (add magicLinkUrl to response)
[ ] 10. Configure SMTP in .env (Gmail app password)
[ ] 11. Test email sending locally
[ ] 12. Deploy to production
[ ] 13. Monitor logs (Winston + Sentry)

ğŸ§ª Testing
bash
# Test magic link generation
curl -X POST http://localhost:3000/trpc/waitlist.join \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com"}'

# Response includes magicLinkUrl

# Test authentication
curl -X POST http://localhost:3000/trpc/waitlist.authenticateWithMagicLink \
  -H "Content-Type: application/json" \
  -d '{"token": "a3f5b2c1..."}'

# Sets cookie and returns stats
ğŸ“§ Email Template
Professional HTML email with:

Welcome message

"Access My Stats" button (CTA)

Referral code display

Referral link for sharing

Responsive design (mobile-friendly)

Plain text fallback

